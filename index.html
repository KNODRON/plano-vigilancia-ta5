<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plano Interactivo – Sistema de Vigilancia (TA_5) | San Antonio</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 999;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      max-width: 420px;
    }
    .panel h1 { font-size: 14px; margin: 0 0 6px; }
    .panel .sub { font-size: 12px; margin: 0 0 8px; color: #333; line-height: 1.25; }
    .badge { display:inline-block; padding:2px 8px; border-radius: 999px;
      border:1px solid #ddd; font-size: 11px; background: #fff; margin-right:6px; margin-bottom:6px; }
    .note { font-size: 11px; margin-top: 8px; color: #444; line-height: 1.25; }
    .label {
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 700;
      color: #111;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="panel">
    <h1>Plano interactivo – Sistema de Vigilancia (Caso TA_5)</h1>
    <div class="sub">
      Ubicación: Camino a Malvilla S/N, Km 101, Ruta 78, San Antonio, Chile<br>
      Vista: <b>Satelital</b> (se puede cambiar en el control de capas arriba a la derecha)
    </div>
    <div class="note">
      <b>SISTEMAS DE VIGILANCIA</b>
    </div>
    <div class="note">
      <b>Profesor</b>: CRISTIAN R. CLAVERIA POBLETE
      </div>
    <div class="note">
      <b>Alumno</b>: JUAN E. JIMÉNEZ VALDIVIA
    </div>
  </div>

<script>
  const SITE_CENTER = [-33.563584, -71.530690];

  // Basemaps
  const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  });
  const esriSat = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 19, attribution: 'Tiles &copy; Esri' }
  );

  const map = L.map('map', {
    zoomControl: false,
    layers: [esriSat]
  }).setView(SITE_CENTER, 17);

  L.control.zoom({ position: 'bottomright' }).addTo(map);

  const NorthControl = L.Control.extend({
  options: { position: 'bottomright' },
  onAdd: function () {
    const div = L.DomUtil.create('div', 'north-control');
    div.innerHTML = '<div class="north-arrow"></div><div class="north-letter">N</div>';
    L.DomEvent.disableClickPropagation(div);
    return div;
  }
});
(new NorthControl()).addTo(map);

  // Layers
  const layerPerimetro = L.layerGroup().addTo(map);
  const layerGates     = L.layerGroup().addTo(map);
  const layerOficinas  = L.layerGroup().addTo(map);
  const layerGaritas   = L.layerGroup().addTo(map);
  const layerCCTV      = L.layerGroup().addTo(map);
  const layerPTZ       = L.layerGroup().addTo(map);
  const layerConos     = L.layerGroup().addTo(map);

  // Icons (colores)
  const iconGate = new L.Icon({
    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png",
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
  });
  const iconOficina = new L.Icon({
    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
  });
  const iconCCTV = new L.Icon({
    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
  });
  const iconPTZ = new L.Icon({
    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png",
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
  });

  // Data from Excel (embedded)
  const PERIMETRO = [[-33.561849, -71.530684], [-33.563646, -71.530721], [-33.563726,	-71.527809], [-33.565268,	-71.527894], [-33.565031,	-71.530695], [-33.563646,	-71.530721], [-33.56378, -71.532907], [-33.56196,	-71.532962], [-33.561849,	-71.530684]];
  const GATES = [{"id": "Gate 1", "lat": -33.563702, "lon": -71.53287}, {"id": "Gate 2", "lat": -33.563538, "lon": -71.530689}, {"id": "Gate 3", "lat": -33.563691, "lon": -71.529562}];
  const GARITAS = [{"id": "Garita 1", "lat": -33.563455, "lon": -71.532766}, {"id": "Garita 2", "lat": -33.563365, "lon": -71.530831}, {"id": "Garita 3", "lat": -33.563737, "lon": -71.529805}];
  const OFICINAS = {"lat": -33.562765, "lon": -71.532688};
  const CAMARAS = [{"id": "C1", "name": "C1 \u2013 C\u00e1mara fija", "lat": -33.561988, "lon": -71.53289, "heading": 131.0, "fov": 80, "range_m": 90}, {"id": "C2", "name": "C2 \u2013 C\u00e1mara fija", "lat": -33.561903, "lon": -71.530689, "heading": 180.0, "fov": 80, "range_m": 90}, {"id": "C3", "name": "C3 \u2013 C\u00e1mara fija", "lat": -33.563753, "lon": -71.53279, "heading": 84.5, "fov": 80, "range_m": 90}, {"id": "C4", "name": "C4 \u2013 C\u00e1mara fija", "lat": -33.563594, "lon": -71.530749, "heading": 78.3, "fov": 80, "range_m": 90}, {"id": "C5", "name": "C5 \u2013 C\u00e1mara fija", "lat": -33.563665, "lon": -71.530535, "heading": 302.1, "fov": 80, "range_m": 90}, {"id": "C6", "name": "C6 \u2013 C\u00e1mara fija", "lat": -33.564979, "lon": -71.530605, "heading": 357.1, "fov": 80, "range_m": 90}, {"id": "C7", "name": "C7 \u2013 C\u00e1mara fija", "lat": -33.565056, "lon": -71.527887, "heading": 302.2, "fov": 80, "range_m": 90}, {"id": "C8", "name": "C8 \u2013 C\u00e1mara fija", "lat": -33.563761, "lon": -71.527873, "heading": 274.3, "fov": 80, "range_m": 90}, {"id": "C9", "name": "C9 \u2013 C\u00e1mara fija", "lat": -33.563207, "lon": -71.530802, "heading": 166.1, "fov": 80, "range_m": 90}];
  const PTZ = {"lat": -33.563154, "lon": -71.530796, "radius_m": 228};

  // Helpers
  function sectorPolygon(lat, lon, headingDeg, fovDeg, rangeDeg, steps=28) {
    const pts = [[lat, lon]];
    const start = headingDeg - (fovDeg/2);
    const end   = headingDeg + (fovDeg/2);
    const toRad = (d) => d * Math.PI / 180;

    for (let i=0;i<=steps;i++) {
      const ang = start + (i*(end-start)/steps);
      const a = toRad(ang);
      const dLat = rangeDeg * Math.cos(a);
      const dLon = rangeDeg * Math.sin(a);
      pts.push([lat + dLat, lon + dLon]);
    }
    pts.push([lat, lon]);
    return pts;
  }

  // 1) Perímetro (línea roja)
  if (PERIMETRO.length >= 3) {
    const poly = L.polyline(PERIMETRO.concat([PERIMETRO[0]]), {
      color: "#ff0000", weight: 3, opacity: 0.95
    }).bindPopup("<b>Perímetro del predio</b><br>Línea roja").addTo(layerPerimetro);

    map.fitBounds(poly.getBounds().pad(0.15));
  }

  // 2) Gates
  GATES.forEach(g => {
    L.marker([g.lat, g.lon], { icon: iconGate })
      .bindPopup(`<b>${g.id}</b>`)
      .bindTooltip(g.id, { permanent:true, direction:"right", className:"label", offset:[10,0] })
      .addTo(layerGates);
  });

  // 3) Oficinas
  if (OFICINAS) {
    L.marker([OFICINAS.lat, OFICINAS.lon], { icon: iconOficina })
      .bindPopup("<b>Oficinas</b>")
      .bindTooltip("Oficinas", { permanent:true, direction:"right", className:"label", offset:[10,0] })
      .addTo(layerOficinas);
  }

  // 4) Garitas
  GARITAS.forEach(g => {
    L.circleMarker([g.lat, g.lon], { radius: 8, weight: 2, fillOpacity: 0.85 })
      .bindPopup(`<b>${g.id}</b>`)
      .bindTooltip(g.id, { permanent:true, direction:"left", className:"label", offset:[-10,0] })
      .addTo(layerGaritas);
  });

  // 5) Cámaras fijas + conos (FOV)
  //    Nota: rangeDeg aproximado. 0.00090 ~ 100m en lat.
  function metersToDeg(m) {
    return m / 111000; // aproximación
  }

  CAMARAS.forEach(c => {
    L.marker([c.lat, c.lon], { icon: iconCCTV })
      .bindPopup(`<b>${c.name}</b><br>FOV: ${c.fov}°<br>Heading: ${c.heading}°<br>Alcance: ${c.range_m}m`)
      .bindTooltip(c.id, { permanent:true, direction:"top", className:"label", offset:[0,-10] })
      .addTo(layerCCTV);

    const rangeDeg = metersToDeg(c.range_m);
    const poly = sectorPolygon(c.lat, c.lon, c.heading, c.fov, rangeDeg);
    L.polygon(poly, { weight: 1, fillOpacity: 0.18 })
      .bindPopup(`<b>Cono (FOV)</b><br>${c.name}`)
      .addTo(layerConos);
  });

  // 6) PTZ (círculo de cobertura)
  if (PTZ) {
    L.marker([PTZ.lat, PTZ.lon], { icon: iconPTZ })
      .bindPopup(`<b>PTZ</b><br>Cobertura referencial: ${PTZ.radius_m}m`)
      .bindTooltip("PTZ", { permanent:true, direction:"right", className:"label", offset:[10,0] })
      .addTo(layerPTZ);

    L.circle([PTZ.lat, PTZ.lon], {
      radius: PTZ.radius_m,
      weight: 2,
      fillOpacity: 0.08
    }).bindPopup("<b>Cobertura PTZ</b><br>(referencial)").addTo(layerPTZ);
  }

  // Layer control
  const baseMaps = {
    "Satelital (Esri)": esriSat,
    "Mapa (OSM)": osm
  };
  const overlays = {
    "Perímetro (rojo)": layerPerimetro,
    "Gates": layerGates,
    "Oficinas": layerOficinas,
    "Garitas": layerGaritas,
    "Cámaras (CCTV)": layerCCTV,
    "Conos / Ángulos (FOV)": layerConos,
    "PTZ": layerPTZ
  };
  L.control.layers(baseMaps, overlays, { collapsed: false }).addTo(map);
</script>
</body>
</html>
